---
- name: Check Docker version
  command: docker --version
  register: dockerVersion

- name: Print Docker version
  debug:
    msg: "Docker Version: {{ dockerVersion.stdout }}"

- name: Get info for Docker container
  docker_container_info:
    name: "{{ CONTAINER_NAME }}"
  register: result

- name: Does container exist?
  debug:
    msg: "The container {{ 'exists' if result.exists else 'does not exist' }}"

  # Container exist
- name: Stop the container if it exists
  docker_container:
    name: "{{ CONTAINER_NAME }}"
    state: stopped
  when: result.exists

- name: Remove the container if it exists
  docker_container:
    name: "{{ CONTAINER_NAME }}"
    state: absent
  when: result.exists

- name: Remove the container image after the container is stopped
  docker_image:
    name: "{{ IMAGE_NAME }}"
    state: absent
  when: result.exists

  # Container not exist
- name: Pull and run the container if it does not exist
  docker_container:
    name: "{{ CONTAINER_NAME }}"
    image: "{{ IMAGE_NAME }}"
    ports:
      - "{{ EXTERNAL_PORT }}:{{ INTERNAL_PORT }}"
    state: started
  when: not result.exists

- name: Print the status of the container
  debug:
    msg: "The container status is {{ result.container['State']['Status'] }}"
  when: result.exists